<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Policy Quote</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-100 font-sans p-4 md:p-8">

    <div class="max-w-2xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-200">
        <div class="bg-blue-900 p-8 text-center text-white">
            <h1 id="org-name" class="text-3xl font-bold mb-2">Loading Society...</h1>
            <p class="text-blue-200 text-sm italic">"United We Stand - Divide We Fall"</p>
        </div>

        <div class="p-8">
            <h2 class="text-xl font-bold text-gray-800 mb-6 border-b pb-2">Calculate Your Monthly Premium</h2>
            
            <form id="quote-form" class="space-y-6">
                
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">1. Select Your Base Plan</label>
                    <select id="plan-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-gray-50">
                        <option value="0" data-benefits="">-- Choose a Plan --</option>
                    </select>
                    <p id="plan-benefits" class="text-xs text-green-700 mt-2 font-medium bg-green-50 p-3 rounded-lg hidden"></p>
                </div>

                <div id="addons-container" class="space-y-3 hidden">
                    <label class="block text-sm font-bold text-gray-700 mb-2">2. Add Extended Family (Optional)</label>
                </div>

                <div class="bg-gray-800 text-white p-6 rounded-xl flex justify-between items-center shadow-inner mt-8">
                    <div>
                        <p class="text-sm text-gray-400 uppercase tracking-wider font-bold">Estimated Monthly Premium</p>
                        <p class="text-xs text-gray-400 mt-1">Based on current rates.</p>
                    </div>
                    <div class="text-right">
                        <span class="text-3xl font-bold text-green-400" id="total-price">R0.00</span>
                        <span class="text-sm">/ month</span>
                    </div>
                </div>

                <button type="button" id="accept-btn" onclick="acceptQuoteAndDownload()" disabled class="w-full mt-6 bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transition disabled:opacity-50 disabled:cursor-not-allowed">
                    üì• Download PDF & Accept Quote
                </button>

            </form>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const CHURCH_CODE = urlParams.get('code') || 'TFBS'; // Swapped fallback to TFBS

        const planSelect = document.getElementById('plan-select');
        const benefitsBox = document.getElementById('plan-benefits');
        const addonsContainer = document.getElementById('addons-container');
        const totalPriceEl = document.getElementById('total-price');
        const acceptBtn = document.getElementById('accept-btn'); // üöÄ New Button Reference

        let currentPlans = [];
        let currentAddons = [];
        
        // üöÄ Variables to hold state for the PDF
        let finalTotal = 0;
        let finalPlanName = '';

        // 1. Fetch data from the database
        async function loadQuoteData() {
            try {
                const res = await fetch(`/api/public/quote-data/${CHURCH_CODE}`);
                const data = await res.json();

                if(data.success) {
                    document.getElementById('org-name').innerText = data.orgName;
                    currentPlans = data.plans;
                    currentAddons = data.addons;
                    populateUI();
                } else {
                    alert("Could not load society pricing.");
                }
            } catch (e) {
                console.error("Error loading quote data", e);
            }
        }

        // 2. Build the UI dynamically
        function populateUI() {
            // Populate Plans
            currentPlans.forEach(plan => {
                const option = document.createElement('option');
                option.value = plan.monthlyPremium;
                option.dataset.benefits = plan.benefitsSummary;
                option.dataset.planname = plan.planName; // üöÄ Save plan name for PDF
                option.textContent = `${plan.planName} - ${plan.targetGroup} (R${plan.monthlyPremium})`;
                planSelect.appendChild(option);
            });

            // Populate Addons (if any exist in the DB)
            if (currentAddons.length > 0) {
                addonsContainer.classList.remove('hidden');
                currentAddons.forEach(addon => {
                    addonsContainer.innerHTML += `
                        <div class="flex justify-between items-center bg-gray-50 p-3 rounded border">
                            <span class="text-sm text-gray-700 addon-name">${addon.addonName} (+R${addon.monthlyCost})</span>
                            <input type="number" min="0" max="10" value="0" class="addon-input w-20 p-2 border rounded text-center" data-cost="${addon.monthlyCost}">
                        </div>
                    `;
                });
            }

            // Add Event Listeners to recalculate on change
            planSelect.addEventListener('change', calculateTotal);
            // Need to re-bind inputs since we used innerHTML
            document.querySelectorAll('.addon-input').forEach(input => {
                input.addEventListener('input', calculateTotal);
            });
        }

        // 3. The Calculation Engine
        function calculateTotal() {
            let total = 0;
            const selectedOption = planSelect.options[planSelect.selectedIndex];

            // üöÄ Disable button if no plan is selected
            if (selectedOption.value === "0") {
                acceptBtn.disabled = true;
                benefitsBox.classList.add('hidden');
                totalPriceEl.textContent = "R0.00";
                return;
            }

            acceptBtn.disabled = false;
            finalPlanName = selectedOption.dataset.planname;
            
            // Add Base Plan
            total += parseFloat(selectedOption.value);

            // Show Benefits
            benefitsBox.textContent = "Includes: " + selectedOption.dataset.benefits;
            benefitsBox.classList.remove('hidden');

            // Add Extras
            document.querySelectorAll('.addon-input').forEach(input => {
                const qty = parseInt(input.value) || 0;
                const cost = parseFloat(input.dataset.cost);
                total += (qty * cost);
            });

            // Update UI & State
            finalTotal = total;
            totalPriceEl.textContent = "R" + total.toFixed(2);
        }

        // üöÄ 4. Generate PDF and Redirect to WhatsApp
        // üöÄ 4. Generate PDF and Send to WhatsApp
        function acceptQuoteAndDownload() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const orgName = document.getElementById('org-name').innerText;
            
            // --- PDF STYLING (Same as before) ---
            doc.setFont("helvetica", "bold");
            doc.setFontSize(22);
            doc.text(orgName, 20, 20);
            doc.setFontSize(14);
            doc.setTextColor(100);
            doc.text("Official Policy Quote", 20, 30);
            doc.setFontSize(10);
            doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, 40);
            doc.setDrawColor(200);
            doc.line(20, 45, 190, 45); 
            doc.setTextColor(0);
            doc.setFont("helvetica", "bold");
            doc.text("Base Plan:", 20, 55);
            doc.setFont("helvetica", "normal");
            doc.text(finalPlanName, 20, 62);
            doc.text(`ZAR ${parseFloat(planSelect.value).toFixed(2)}`, 170, 62, { align: "right" });
            
            let yPos = 75;
            const addonInputs = document.querySelectorAll('.addon-input');
            let hasAddons = false;
            
            addonInputs.forEach(input => {
                const qty = parseInt(input.value) || 0;
                if (qty > 0) {
                    if (!hasAddons) {
                        doc.setFont("helvetica", "bold");
                        doc.text("Extended Family Dependents:", 20, yPos);
                        doc.setFont("helvetica", "normal");
                        yPos += 7;
                        hasAddons = true;
                    }
                    const cost = parseFloat(input.dataset.cost) * qty;
                    const addonNameRaw = input.previousElementSibling.innerText; 
                    const cleanName = addonNameRaw.split(' (+')[0]; 
                    
                    doc.text(`${qty}x ${cleanName}`, 20, yPos);
                    doc.text(`ZAR ${cost.toFixed(2)}`, 170, yPos, { align: "right" });
                    yPos += 7;
                }
            });

            yPos += 10;
            doc.line(20, yPos, 190, yPos); 
            yPos += 10;
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.text("Total Estimated Premium:", 20, yPos);
            doc.text(`ZAR ${finalTotal.toFixed(2)} / month`, 170, yPos, { align: "right" });

            // --- üöÄ NEW SEND LOGIC ---
            const btn = document.getElementById('accept-btn');
            btn.innerText = "‚è≥ Sending Quote to WhatsApp...";
            btn.disabled = true;

            const phone = urlParams.get('phone');
            const botNumber = urlParams.get('bot') || "27821234567"; // Fallback to a default if missing
            const pdfBase64 = doc.output('datauristring'); // Get PDF as Base64 text

            // Always download a local copy just in case
            doc.save(`Quote_${orgName.replace(/ /g, '_')}.pdf`);

            const waMsg = `Hello! I accept the quote for the *${finalPlanName}* at *R${finalTotal.toFixed(2)}/month*. Let's finish my registration.`;

            if (phone) {
                // Send PDF to backend API
                fetch('/api/public/send-quote', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone, pdfBase64, orgName })
                }).then(() => {
                    // Redirect to WhatsApp chat after successful send
                    window.location.href = `https://wa.me/${botNumber}?text=${encodeURIComponent(waMsg)}`;
                }).catch(() => {
                    alert("‚ö†Ô∏è PDF generated locally, but failed to send to WhatsApp. Redirecting to chat...");
                    window.location.href = `https://wa.me/${botNumber}?text=${encodeURIComponent(waMsg)}`;
                });
            } else {
                // If they opened the link directly without a phone number
                window.location.href = `https://wa.me/${botNumber}?text=${encodeURIComponent(waMsg)}`;
            }
        }

        // Initialize
        loadQuoteData();
    </script>
</body>
</html>