<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Policy Quote</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans p-4 md:p-8">

    <div class="max-w-2xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-200">
        <div class="bg-blue-900 p-8 text-center text-white">
            <h1 id="org-name" class="text-3xl font-bold mb-2">Loading Society...</h1>
            <p class="text-blue-200 text-sm italic">"United We Stand - Divide We Fall"</p>
        </div>

        <div class="p-8">
            <h2 class="text-xl font-bold text-gray-800 mb-6 border-b pb-2">Calculate Your Monthly Premium</h2>
            
            <form id="quote-form" class="space-y-6">
                
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">1. Select Your Base Plan</label>
                    <select id="plan-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-gray-50">
                        <option value="0" data-benefits="">-- Choose a Plan --</option>
                        </select>
                    <p id="plan-benefits" class="text-xs text-green-700 mt-2 font-medium bg-green-50 p-3 rounded-lg hidden"></p>
                </div>

                <div id="addons-container" class="space-y-3 hidden">
                    <label class="block text-sm font-bold text-gray-700 mb-2">2. Add Extended Family (Optional)</label>
                    </div>

                <div class="bg-gray-800 text-white p-6 rounded-xl flex justify-between items-center shadow-inner mt-8">
                    <div>
                        <p class="text-sm text-gray-400 uppercase tracking-wider font-bold">Estimated Monthly Premium</p>
                        <p class="text-xs text-gray-400 mt-1">Based on current rates.</p>
                    </div>
                    <div class="text-right">
                        <span class="text-3xl font-bold text-green-400" id="total-price">R0.00</span>
                        <span class="text-sm">/ month</span>
                    </div>
                </div>

            </form>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const CHURCH_CODE = urlParams.get('code') || 'BS-001'; // Fallback for testing

        const planSelect = document.getElementById('plan-select');
        const benefitsBox = document.getElementById('plan-benefits');
        const addonsContainer = document.getElementById('addons-container');
        const totalPriceEl = document.getElementById('total-price');

        let currentPlans = [];
        let currentAddons = [];

        // 1. Fetch data from the database
        async function loadQuoteData() {
            try {
                const res = await fetch(`/api/public/quote-data/${CHURCH_CODE}`);
                const data = await res.json();

                if(data.success) {
                    document.getElementById('org-name').innerText = data.orgName;
                    currentPlans = data.plans;
                    currentAddons = data.addons;
                    populateUI();
                } else {
                    alert("Could not load society pricing.");
                }
            } catch (e) {
                console.error("Error loading quote data", e);
            }
        }

        // 2. Build the UI dynamically
        function populateUI() {
            // Populate Plans
            currentPlans.forEach(plan => {
                const option = document.createElement('option');
                option.value = plan.monthlyPremium;
                option.dataset.benefits = plan.benefitsSummary;
                option.textContent = `${plan.planName} - ${plan.targetGroup} (R${plan.monthlyPremium})`;
                planSelect.appendChild(option);
            });

            // Populate Addons (if any exist in the DB)
            if (currentAddons.length > 0) {
                addonsContainer.classList.remove('hidden');
                currentAddons.forEach(addon => {
                    addonsContainer.innerHTML += `
                        <div class="flex justify-between items-center bg-gray-50 p-3 rounded border">
                            <span class="text-sm text-gray-700">${addon.addonName} (+R${addon.monthlyCost})</span>
                            <input type="number" min="0" value="0" class="addon-input w-20 p-2 border rounded text-center" data-cost="${addon.monthlyCost}">
                        </div>
                    `;
                });
            }

            // Add Event Listeners to recalculate on change
            planSelect.addEventListener('change', calculateTotal);
            document.querySelectorAll('.addon-input').forEach(input => {
                input.addEventListener('input', calculateTotal);
            });
        }

        // 3. The Calculation Engine
        function calculateTotal() {
            let total = 0;

            // Add Base Plan
            const selectedPlanPrice = parseFloat(planSelect.value);
            total += selectedPlanPrice;

            // Show Benefits
            const selectedOption = planSelect.options[planSelect.selectedIndex];
            if(selectedOption.value !== "0") {
                benefitsBox.textContent = "Includes: " + selectedOption.dataset.benefits;
                benefitsBox.classList.remove('hidden');
            } else {
                benefitsBox.classList.add('hidden');
            }

            // Add Extras
            document.querySelectorAll('.addon-input').forEach(input => {
                const qty = parseInt(input.value) || 0;
                const cost = parseFloat(input.dataset.cost);
                total += (qty * cost);
            });

            // Update UI
            totalPriceEl.textContent = "R" + total.toFixed(2);
        }

        // Initialize
        loadQuoteData();
    </script>
</body>
</html>