// ==========================================
// PRISMA SCHEMA - CLEAN VERSION
// ==========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- USER & MEMBERSHIP ---
model Member {
  id             Int      @id @default(autoincrement())
  firstName      String
  lastName       String
  phone          String   @unique
  email          String?
  createdAt      DateTime @default(now())
  monthlyPremium Float? // <--- ADD THIS LINE
  idType           String?   @default("SA_ID") 
  idNumber         String?   // Stores ENCRYPTED data (e.g. "a1b2:f9e8...")
  address          String?   // Stores ENCRYPTED data
  kycToken         String?   @unique
  kycTokenExpires  DateTime?
  idPhotoUrl       String?  // Stores encrypted Cloudinary URL
  proofOfAddressUrl String? // Stores encrypted Cloudinary URL
  isIdVerified     Boolean   @default(false)
  rejectionReason  String?
  verifiedAt       DateTime?

  // Link 1: Church (Optional)
  churchCode String?
  church     Church? @relation("ChurchMembers", fields: [churchCode], references: [code])

  // Link 2: Burial Society (Optional)
  societyCode String?
  society     Church? @relation("SocietyMembers", fields: [societyCode], references: [code])

  // Society Data
  status       String   @default("ACTIVE")
  policyNumber String?
  joinedAt     DateTime @default(now())

  dependents   Dependent[]
  transactions Transaction[]
  claims       Claim[]
}

model Dependent {
  id          Int       @id @default(autoincrement())
  firstName   String
  lastName    String
  relation    String
  dateOfBirth DateTime?
  memberId    Int
  member      Member    @relation(fields: [memberId], references: [id])
  createdAt   DateTime  @default(now())
}

// --- ORGANIZATIONS ---
model Church {
  id             Int       @id @default(autoincrement())
  code           String    @unique
  name           String
  type           String // "CHURCH" or "SOCIETY"
  adminPhone     String?
  defaultPremium Float?    @default(150.0)
  otp            String?
  otpExpires     DateTime?
  createdAt      DateTime  @default(now())

  // Relations
  admins Admin[]

  // Explicitly named relations to solve the Member error:
  churchMembers  Member[] @relation("ChurchMembers")
  societyMembers Member[] @relation("SocietyMembers")

  transactions Transaction[]
  events       Event[]
  claims       Claim[]
  ads          Ad[]
  news         News[] // âœ… Added this to fix the News error
}

enum OrgType {
  CHURCH
  BURIAL_SOCIETY
  NON_PROFIT
}

// --- FINANCES & CONTENT ---
model Transaction {
  id         Int      @id @default(autoincrement())
  churchCode String
  church     Church   @relation(fields: [churchCode], references: [code])
  phone      String
  member     Member?  @relation(fields: [phone], references: [phone]) // Optional link for history
  type       String // OFFERING, TITHE, PREM, TICKET
  amount     Float
  reference  String   @unique
  status     String // ðŸ‘ˆ Is the default 'pending' or 'PENDING'?
  date       DateTime @default(now())
}

model Event {
  id          Int      @id @default(autoincrement())
  churchCode  String
  church      Church   @relation(fields: [churchCode], references: [code])
  name        String
  date        String
  price       Float
  isDonation  Boolean  @default(false) // ðŸ‘ˆ This powers the "Any Amount" logic
  description String?
  status      String   @default("Active")
  expiryDate  DateTime
}

model News {
  id         Int      @id @default(autoincrement())
  headline   String
  body       String?
  status     String   @default("Active")
  expiryDate DateTime
  createdAt  DateTime @default(now())

  churchId Int    @default(1)
  church   Church @relation(fields: [churchId], references: [id])
}

model Ad {
  id         Int      @id @default(autoincrement())
  churchId   Int
  church     Church   @relation(fields: [churchId], references: [id])
  content    String
  imageUrl   String? // ðŸŸ¢ RE-ADD THIS to prevent crashes
  isPlatform Boolean  @default(false)
  views      Int      @default(0)
  status     String   @default("Active")
  expiryDate DateTime
  createdAt  DateTime @default(now())
}

model Claim {
  id Int @id @default(autoincrement())

  // Link to Church
  churchCode String
  church     Church @relation(fields: [churchCode], references: [code])

  // Link to Member
  memberPhone String
  member      Member @relation(fields: [memberPhone], references: [phone])

  beneficiaryName String
  payoutAmount    Float
  status          String   @default("PENDING") // PENDING, APPROVED, PAID, DECLINED
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Admin {
  id        Int      @id @default(autoincrement())
  phone     String   @unique
  name      String?
  role      String   @default("STAFF")
  church    Church   @relation(fields: [churchId], references: [id])
  churchId  Int
  createdAt DateTime @default(now())
}
