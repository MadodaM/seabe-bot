// ==========================================
// PRISMA SCHEMA - CLEAN VERSION
// ==========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- USER & MEMBERSHIP ---
model Member {
  id                Int       @id @default(autoincrement())
  firstName         String
  lastName          String
  phone             String    @unique
  email             String?
  createdAt         DateTime  @default(now())
  monthlyPremium    Float? // <--- ADD THIS LINE
  idType            String?   @default("SA_ID")
  idNumber          String? // Stores ENCRYPTED data (e.g. "a1b2:f9e8...")
  address           String? // Stores ENCRYPTED data
  kycToken          String?   @unique
  kycTokenExpires   DateTime?
  idPhotoUrl        String? // Stores encrypted Cloudinary URL
  proofOfAddressUrl String? // Stores encrypted Cloudinary URL
  isIdVerified      Boolean   @default(false)
  rejectionReason   String?
  verifiedAt        DateTime?

  // Link 1: Church (Optional)
  churchCode String?
  church     Church? @relation("ChurchMembers", fields: [churchCode], references: [code])

  // Link 2: Burial Society (Optional)
  societyCode String?
  society     Church? @relation("SocietyMembers", fields: [societyCode], references: [code])

  // Society Data
  status       String   @default("ACTIVE")
  policyNumber String?
  joinedAt     DateTime @default(now())

  dependents   Dependent[]
  transactions Transaction[]
  claims       Claim[]
  collections  Collection[]
  riskFlags    RiskFlag[]
}

model Dependent {
  id          Int    @id @default(autoincrement())
  firstName   String
  lastName    String
  dateOfBirth String // ðŸ‘ˆ Changed from idNumber to dateOfBirth
  relation    String
  status      String @default("ACTIVE")
  memberId    Int
  member      Member @relation(fields: [memberId], references: [id])
}

// --- ORGANIZATIONS ---
model Church {
  id         Int     @id @default(autoincrement())
  code       String  @unique
  name       String
  type       String // "CHURCH" or "BURIAL_SOCIETY"
  adminPhone String?
  email      String? // âœ… Fixed

  // FICA Level 1 (Initial FICA)
  pastorIdUrl    String? // Cloudinary Vault Link
  proofOfBankUrl String? // Cloudinary Vault Link

  // FICA Level 2 (Corporate FICA)
  npcRegUrl      String?
  cipcDocUrl     String?
  directorIdsUrl String? // Can be an array or single merged PDF link

  // State Machine for FICA Flow
  ficaStatus String @default("LEVEL_1_PENDING")
  // Statuses: LEVEL_1_PENDING -> AWAITING_LEVEL_2 -> LEVEL_2_PENDING -> NETCASH_READY -> ACTIVE

  // Financial Fields
  defaultPremium  Float?  @default(150.0)
  subscriptionFee Float?  @default(0.0) // âœ… Added to match your code
  subaccountCode  String? // âœ… Renamed from 'Subaccount' to match your code

  otp           String?
  otpExpires    DateTime?
  createdAt     DateTime  @default(now())
  tosAcceptedAt DateTime? // ðŸ‘ˆ Add this so web.js can save the Terms agreement

  // Relations
  admins Admin[]

  // Member Relations
  churchMembers  Member[] @relation("ChurchMembers")
  societyMembers Member[] @relation("SocietyMembers")

  transactions   Transaction[]
  events         Event[]
  claims         Claim[]
  ads            Ad[]
  news           News[]
  // Procurement Relations
  vendors        Vendor[]
  rfqs           RequestForQuote[]
  purchaseOrders PurchaseOrder[]

  // ðŸ“‹ Dynamic Policy Relations
  plans  PolicyPlan[]
  addons PolicyAddon[]
}

enum OrgType {
  CHURCH
  BURIAL_SOCIETY
  NON_PROFIT
  SERVICE_PROVIDER
}

// --- FINANCES & CONTENT ---
model Transaction {
  id         Int      @id @default(autoincrement())
  churchCode String
  church     Church   @relation(fields: [churchCode], references: [code])
  phone      String
  member     Member?  @relation(fields: [phone], references: [phone]) // Optional link for history
  type       String // OFFERING, TITHE, PREM, TICKET
  amount     Float
  reference  String   @unique
  status     String // ðŸ‘ˆ Is the default 'pending' or 'PENDING'?
  method     String? // ðŸ‘ˆ Add this line!
  date       DateTime @default(now())
}

model Event {
  id          Int      @id @default(autoincrement())
  churchCode  String
  church      Church   @relation(fields: [churchCode], references: [code])
  name        String
  date        String
  price       Float
  isDonation  Boolean  @default(false) // ðŸ‘ˆ This powers the "Any Amount" logic
  description String?
  status      String   @default("Active")
  expiryDate  DateTime
}

model News {
  id         Int      @id @default(autoincrement())
  headline   String
  body       String?
  status     String   @default("Active")
  expiryDate DateTime
  createdAt  DateTime @default(now())

  churchId Int    @default(1)
  church   Church @relation(fields: [churchId], references: [id])
}

model Ad {
  id         Int      @id @default(autoincrement())
  churchId   Int
  church     Church   @relation(fields: [churchId], references: [id])
  content    String
  imageUrl   String? // ðŸŸ¢ RE-ADD THIS to prevent crashes
  isPlatform Boolean  @default(false)
  views      Int      @default(0)
  status     String   @default("Active")
  expiryDate DateTime
  createdAt  DateTime @default(now())
}

model Claim {
  id Int @id @default(autoincrement())

  // Link to Church
  churchCode String
  church     Church @relation(fields: [churchCode], references: [code])

  // Link to Member
  memberPhone String
  member      Member @relation(fields: [memberPhone], references: [phone])

  beneficiaryName String
  payoutAmount    Float
  status          String @default("PENDING") // PENDING, APPROVED, PAID, DECLINED

  // --------------------------------------------------
  // âœ¨ NEW AI & DOCUMENT FIELDS (REQUIRED FOR ADMIN UI)
  // --------------------------------------------------
  deceasedIdNumber String?
  dateOfDeath      DateTime?
  causeOfDeath     String?
  claimantPhone    String?
  documentUrl      String?
  adminNotes       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Admin {
  id        Int      @id @default(autoincrement())
  phone     String   @unique
  name      String?
  role      String   @default("STAFF")
  church    Church   @relation(fields: [churchId], references: [id])
  churchId  Int
  createdAt DateTime @default(now())
}

model Collection {
  id         Int      @id @default(autoincrement())
  churchCode String
  firstName  String
  lastName   String?
  phone      String
  email      String?
  amount     Float
  reference  String
  status     String   @default("PENDING")
  createdAt  DateTime @default(now())

  memberId Int?
  member   Member? @relation(fields: [memberId], references: [id])
}

model AuditLog {
  id        String   @id @default(uuid())
  adminId   String // The ID of the admin or system process making the change
  action    String // e.g., 'CREATE', 'UPDATE', 'DELETE'
  modelName String // The table being modified (e.g., 'Collection', 'Member', 'Policy')
  recordId  String // The specific ID of the row being altered
  oldData   Json? // A complete snapshot of the row BEFORE the change
  newData   Json? // A complete snapshot of the row AFTER the change
  ipAddress String? // (Optional) Track the network location of the admin
  createdAt DateTime @default(now())

  @@index([adminId])
  @@index([modelName, recordId])
}

model RiskFlag {
  id          Int    @id @default(autoincrement())
  memberPhone String
  member      Member @relation(fields: [memberPhone], references: [phone])

  flagType    String // "VELOCITY_SPIKE", "DUPLICATE_CLAIM", "FICA_EXPIRED"
  severity    String // "LOW", "MEDIUM", "CRITICAL"
  description String // e.g., "User paid from 3 different IPs in 24 hours"
  status      String @default("OPEN") // OPEN, INVESTIGATING, RESOLVED

  createdAt DateTime @default(now())
}

// ==========================================
// ðŸ›’ PROCUREMENT & VENDOR MODULE
// ==========================================

model Vendor {
  id             Int             @id @default(autoincrement())
  churchId       Int
  church         Church          @relation(fields: [churchId], references: [id])
  name           String
  category       String // e.g., Catering, Tent Hire, Venue, Florist
  phone          String // For WhatsApp RFQs
  email          String?
  bankDetails    String?
  status         String          @default("ACTIVE")
  purchaseOrders PurchaseOrder[]
  quotes         Quote[]
  createdAt      DateTime        @default(now())
}

model RequestForQuote {
  id          Int      @id @default(autoincrement())
  churchId    Int
  church      Church   @relation(fields: [churchId], references: [id])
  title       String
  description String   @db.Text
  requiredBy  DateTime
  status      String   @default("OPEN") // OPEN, CLOSED, FULFILLED
  quotes      Quote[]
  createdAt   DateTime @default(now())
}

model Quote {
  id        Int             @id @default(autoincrement())
  rfqId     Int
  rfq       RequestForQuote @relation(fields: [rfqId], references: [id])
  vendorId  Int
  vendor    Vendor          @relation(fields: [vendorId], references: [id])
  amount    Float
  notes     String?         @db.Text
  status    String          @default("PENDING") // PENDING, ACCEPTED, REJECTED
  createdAt DateTime        @default(now())
}

model PurchaseOrder {
  id        Int      @id @default(autoincrement())
  poNumber  String   @unique
  churchId  Int
  church    Church   @relation(fields: [churchId], references: [id])
  vendorId  Int
  vendor    Vendor   @relation(fields: [vendorId], references: [id])
  amount    Float
  lineItems String   @db.Text // Storing as text/JSON string to avoid DB strictness
  status    String   @default("ISSUED") // ISSUED, FULFILLED, PAID
  createdAt DateTime @default(now())
}

// ==========================================
// ðŸ“‹ DYNAMIC POLICY PLANS
// ==========================================

model PolicyPlan {
  id              Int      @id @default(autoincrement())
  churchId        Int
  church          Church   @relation(fields: [churchId], references: [id])
  planName        String // e.g., "Plan A"
  targetGroup     String // e.g., "Single Member", "Principal + Spouse + 6 Children"
  monthlyPremium  Float // e.g., 160.00
  benefitsSummary String   @db.Text // e.g., "Grocery + Vegetables + 2 Sheep + R500 Cash"
  createdAt       DateTime @default(now())
}

model PolicyAddon {
  id          Int      @id @default(autoincrement())
  churchId    Int
  church      Church   @relation(fields: [churchId], references: [id])
  addonName   String // e.g., "Additional Child", "Additional Adult"
  monthlyCost Float // e.g., 20.00, 30.00
  createdAt   DateTime @default(now())
}
